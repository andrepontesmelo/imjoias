<?xml version="1.0" encoding="utf-8"?>

<Relatório xmlns="http://imjoias/relatorio/graficos/graficos.xsd">

	<!-- Observe que as consultas cuja quantidade utiliza diferença de dias,
	     o valor deve ser acrescido em 1, já que hoje - hoje = 0, porém o
	     dado de hoje aparece no gráfico. -->

	<Gráfico referência="epm" tipo="linhas" título="Entradas por mês" eixoY="Entradas" eixoX ="Mês">
		<Descrição>André é preguiçoso e não colocou descrição</Descrição>

		<!-- Lista de requisitos -->
		<Requisito entrada="período"/>
		<Requisito entrada="setor"/>
		
		<Quantidade>
			SELECT PERIOD_DIFF(DATE_FORMAT(?periodoFinal, '%Y%m'), DATE_FORMAT(?periodoInicial, '%Y%m')) + 1
		</Quantidade>
		
		<Query rótuloX="mes" valorX="x" valorY="quantidade">
			SELECT PERIOD_DIFF(DATE_FORMAT(entrada, '%Y%m'), DATE_FORMAT(?periodoInicial, '%Y%m')) AS x,
			       MONTH(entrada),
			       CASE MONTH(entrada) WHEN 1 THEN 'Janeiro'
			                           WHEN 2 THEN 'Fevereiro'
			                           WHEN 3 THEN 'Março'
			                           WHEN 4 THEN 'Abril'
			                           WHEN 5 THEN 'Maio'
			                           WHEN 6 THEN 'Junho'
			                           WHEN 7 THEN 'Julho'
			                           WHEN 8 THEN 'Agosto'
			                           WHEN 9 THEN 'Setembro'
			                           WHEN 10 THEN 'Outubro'
			                           WHEN 11 THEN 'Novembro'
			                           WHEN 12 THEN 'Dezembro'
                      END AS mes,
			       COUNT(*) AS quantidade
			FROM visita
			WHERE setor = ?setor
			      AND PERIOD_DIFF(DATE_FORMAT(entrada, '%Y%m'), DATE_FORMAT(?periodoInicial, '%Y%m')) BETWEEN 0 AND (SELECT PERIOD_DIFF(DATE_FORMAT(?periodoFinal, '%Y%m'), DATE_FORMAT(?periodoInicial, '%Y%m')))
			GROUP BY MONTH(entrada)
			ORDER BY x
		</Query>
	</Gráfico>	

	<Gráfico referência="epd" tipo="linhasVértices" título="Entradas por dia" eixoY="Entradas" eixoX ="Dia">
		<Descrição>...</Descrição>

		<!-- Lista de requisitos -->
		<Requisito entrada="período"/>
		<Requisito entrada="setor"/>
		
		<Quantidade>
			SELECT DATEDIFF(?periodoFinal ,?periodoInicial) + 1
		</Quantidade>
		
		<Query rótuloX="data" valorX="x" valorY="quantidade">
			SELECT DATEDIFF(date(entrada), ?periodoInicial) AS x,
			       DATE_FORMAT(entrada, '%d/%m/%y') AS data,
			       COUNT(*) AS quantidade
			FROM visita
			WHERE setor = ?setor
			      AND date(entrada) BETWEEN ?periodoInicial AND ?periodoFinal
			GROUP by data
			ORDER BY x
		</Query>
	</Gráfico>
	
	<Gráfico referência="mdecfai" tipo="barras" título="Média do tempo de espera dos clientes que não foram atendidos imediatamente" eixoX="Setor" eixoY="Tempo (minutos)">
		<Descrição>
			Média do tempo de espera dos clientes por setor.
			Apenas esperas maiores de um minuto são contadas.
		</Descrição>

		<Requisito entrada="período"/>
		<Quantidade>
			SELECT COUNT(DISTINCT setor)
			FROM visita
			WHERE date(visita.entrada) BETWEEN '2001-01-01' AND '2005-01-01'
			AND visita.espera > 60
			AND setor is not null
		</Quantidade>

		<!-- Consulta SQL -->
		<Query rótuloX="setor" valorX="contador" valorY="demora">
			set ?c = -1;
			SELECT  ?c := ?c + 1 AS contador,
			avg(visita.espera) /60  as demora,
			setor.nome as setor
			FROM visita,setor
			WHERE date(visita.entrada) BETWEEN ?periodoInicial AND ?periodoFinal
			AND visita.setor = setor.codigo
			AND visita.espera > 60
			AND setor is not null
			AND setor.atendimento = 1
			GROUP by visita.setor ORDER by visita.setor
		</Query>

	
	</Gráfico>


	<Gráfico referência="mted" tipo="linhasVértices" título="Máximo de Tempo de Espera por Dia" eixoX="Data" eixoY="Tempo (minutos)">
		<Descrição>
			Informa o tempo máximo que um visitante precisou esperar 
			para ser atendido em cada dia e em cada setor. 
		</Descrição>
		
		<!-- Lista de requisitos -->
		<Requisito entrada="período"/>

		<Quantidade>
			SELECT DATEDIFF(?periodoFinal, ?periodoInicial) + 1
		</Quantidade>

		<!-- Definição de seqüências -->
		<Seqüência>
			SELECT codigo, nome
			FROM setor
			WHERE atendimento = 1
			ORDER BY nome
		</Seqüência>		
		
		<!-- Consulta SQL -->
		<Query valorX="x" valorY="tempo" seqüência="setor" rótuloX="data">
			SELECT DATEDIFF(DATE(entrada),?periodoInicial) AS x,
			       DATE_FORMAT(entrada, '%d/%m/%y') AS data,
			       visita.setor AS setor,
			       (max(visita.espera)/60) AS tempo
			FROM visita, setor
			WHERE date(visita.entrada) BETWEEN ?periodoInicial AND ?periodoFinal
				AND visita.setor = setor.codigo
				AND setor.atendimento = 1
			GROUP BY data, setor 
		</Query>

	
	</Gráfico>
	
	<Gráfico referência="mehcs" tipo="barras" título="Média de Entrada por Horário Comparativo de Setores" eixoX="Horário" eixoY="Entradas">
	
		<Descrição>
			Descreve a taxa de chegada de visitantes em cada setor,
			permitindo a identificação de períodos críticos e/ou ociosos.
		</Descrição>
		
		<!-- Lista de requisitos -->
		<Requisito entrada="período"/>
		
		<!-- Tamanho dos dados -->
		<Quantidade>
			SELECT 24
		</Quantidade>

		<!-- Definição de seqüências -->
		<Seqüência>
			SELECT codigo, nome
			FROM setor
			WHERE atendimento = 1
			ORDER BY nome
		</Seqüência>
		
		<!-- Consulta SQL -->
		<Query valorX="hora" valorY="visitantes" seqüência="setor">
			SELECT hora, setor, AVG(visitantes) as visitantes
			FROM
			(
				SELECT DATE(v.entrada) AS data, HOUR(v.entrada) AS hora, v.setor, COUNT(*) AS visitantes
				FROM visita v JOIN setor s ON v.setor = s.codigo
				WHERE DATE(v.entrada) BETWEEN ?periodoInicial AND ?periodoFinal
				      AND s.atendimento = 1
				GROUP BY data, hora, setor
			) tVisitantes
			GROUP BY hora, setor
			ORDER BY hora
		</Query>
		
	</Gráfico>
	
	<Gráfico referência="meh" tipo="barras" título="Média de Entrada por Horário" eixoX="Horário" eixoY="Entradas">
	
		<Descrição>
			Descreve a taxa de chegada de visitantes em cada setor,
			permitindo a identificação de períodos críticos e/ou ociosos.
		</Descrição>
		
		<!-- Lista de requisitos -->
		<Requisito entrada="período"/>
		<Requisito entrada="setor"/>
		
		<!-- Tamanho dos dados -->
		<Quantidade>
			SELECT 24
		</Quantidade>

		<!-- Consulta SQL -->
		<Query valorX="hora" valorY="visitantes">
			SELECT hora, AVG(visitantes) as visitantes
			FROM
			(
				SELECT DATE(entrada) AS data, HOUR(entrada) AS hora, COUNT(*) AS visitantes
				FROM visita
				WHERE DATE(entrada) BETWEEN ?periodoInicial AND ?periodoFinal
				      AND setor = ?setor
				GROUP BY data, hora
			) tVisitantes
			GROUP BY hora
			ORDER BY hora
		</Query>
		
	</Gráfico>



	<!-- Relatório Atendimento por Setor -->

	<Gráfico referência="pa" tipo="pizza" título="Proporção de Atendimentos">
	
		<Descrição>
			Proporção de atendimentos por funcinonário
		</Descrição>
		
		<!-- Lista de requisitos -->
		<Requisito entrada="período"/>
		<Requisito entrada="setor"/>
		
		<!-- Tamanho dos dados -->
		<Quantidade>
			SELECT 1
		</Quantidade>

		<!-- Definição de seqüências -->
		<Seqüência>
			SELECT DISTINCT p.codigo, p.nome
			FROM visita v JOIN visitafuncionario vf ON v.entrada = vf.visita JOIN pessoa p ON vf.funcionario = p.codigo
			WHERE vf.visita BETWEEN ?periodoInicial AND ?periodoFinal
			      AND v.setor = ?setor
			ORDER BY p.codigo
		</Seqüência>
		
		<!-- Consulta SQL -->
		<Query valorX="zero" valorY="visitantes" seqüência="funcionario">
			SELECT 0 AS zero, funcionario, COUNT(*) AS visitantes
			FROM visita v JOIN visitafuncionario vf ON v.entrada = vf.visita
			WHERE vf.visita BETWEEN ?periodoInicial AND ?periodoFinal
			      AND v.setor = ?setor
			GROUP BY funcionario
		</Query>
		
	</Gráfico>
	
	<Gráfico referência="mteds" tipo="linhas" título="Máximo de Tempo de Espera por Dia por Setor" eixoX="Data" eixoY="Tempo (minutos)">
		<Descrição>
			Informa o tempo máximo que um visitante precisou esperar 
			para ser atendido em cada dia por setor. 
		</Descrição>
		
		<!-- Lista de requisitos -->
		<Requisito entrada="período"/>
		<Requisito entrada="setor"/>

		<Quantidade>
			SELECT DATEDIFF(?periodoFinal, ?periodoInicial) + 1
		</Quantidade>

		<!-- Consulta SQL -->
		<Query valorX="x" valorY="tempo" rótuloX="data">
			SELECT DATEDIFF(DATE(entrada),?periodoInicial) AS x,
			       DATE_FORMAT(entrada, '%d/%m/%y') AS data,
			       (max(visita.espera)/60) AS tempo
			FROM visita
			WHERE date(visita.entrada) BETWEEN ?periodoInicial AND ?periodoFinal
				AND visita.setor = ?setor
			GROUP BY data
		</Query>

	</Gráfico>

		
</Relatório>